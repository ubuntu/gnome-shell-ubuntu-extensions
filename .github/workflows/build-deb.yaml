name: Build and test debian packages

on:
  push:
    branches: "*"
  pull_request:
    branches: [main]

jobs:
  build-deb-packages:
    name: Ubuntu Devel
    runs-on: ubuntu-latest
    env:
      UBUNTU_VERSION: devel

    outputs:
      run-id: ${{ github.run_id }}
      pkg-dsc:  ${{ steps.outputs.outputs.pkg-dsc }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Prepare sources
        uses: kohlerdominik/docker-run-action@v2.0.0
        id: sources-prepare
        with:
          image: ubuntu:${{ env.UBUNTU_VERSION }}
          environment: |
            TERM=dumb
            DEBIAN_FRONTEND=noninteractive
            DEBCONF_NONINTERACTIVE_SEEN=true
            DEB_BUILD_PROFILE=nocheck
          volumes: |
            ${{ github.workspace }}:${{ github.workspace }}
          workdir: ${{ github.workspace }}
          shell: bash
          run: |
            apt update -y
            apt install -y git-buildpackage
            apt build-dep -y . --build-profiles=${DEB_BUILD_PROFILE}
            mkdir sources
            git config --system --add safe.directory "${PWD}"
            gbp buildpackage --git-export-dir="$PWD/sources" \
              --git-ignore-branch -S --no-sign --build-profiles=${DEB_BUILD_PROFILE}
            find sources
            pkg_dsc=$(ls -1 sources/*.dsc)
            (
              echo "pkg-dsc=$(basename "${pkg_dsc}")"
              echo "pkg-dsc-path=${{ github.workspace }}/${pkg_dsc}"
            ) >> "${GITHUB_OUTPUT}"

      - name: Save source package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-source
          path: ${{ github.workspace }}/sources
          if-no-files-found: error

      - name: Build debian packages
        uses: canonical/desktop-engineering/gh-actions/common/build-debian@main
        with:
          docker-image: ubuntu:${{ env.UBUNTU_VERSION }}
          from-sources-file: ${{ steps.sources-prepare.outputs.pkg-dsc-path }}
          extra-source-build-deps: ''

      - name: Generate outputs
        id: outputs
        run: |
          (
            echo "pkg-name=${{ env.PKG_NAME }}"
            echo "pkg-version=${{ env.PKG_VERSION }}"
            echo "pkg-dsc=${{ steps.sources-prepare.outputs.pkg-dsc }}"
          ) >> "${GITHUB_OUTPUT}"

  run-autopkgtests:
    name: Run autopkgtests
    runs-on: ubuntu-latest
    needs:
      - build-deb-packages
    strategy:
      fail-fast: false
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v5
      with:
        run-id: ${{ needs.build-deb-packages.outputs.run-id }}
        merge-multiple: true

    # FIXME: Drop
    - run: find

    - name: Run autopkgtests
      uses: canonical/desktop-engineering/gh-actions/common/run-autopkgtest@main
      with:
        lxd-image: ubuntu:devel
        source-changes: ${{ needs.build-deb-packages.outputs.pkg-dsc }}
        # FIXME: Drop this when the resolution will be stable again
        #autopkgtest-args: |
        #  --setup-commands='sed -i s,archive.ubuntu.com,azure.archive.ubuntu.com,g /etc/apt/sources.list.d/ubuntu.sources && apt update -y'

  run-gnome-shell-autopkgtests:
    name: Run GNOME Shell autopkgtests
    runs-on: ubuntu-latest
    needs:
      - build-deb-packages
    strategy:
      fail-fast: false
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v5
      with:
        run-id: ${{ needs.build-deb-packages.outputs.run-id }}
        merge-multiple: true

    # FIXME: Drop
    - run: find

        # ACtually support running autopkgtests against other packages with the provided debs!
    - name: Run gnome-shell autopkgtests
      uses: 3v1n0/desktop-engineering/gh-actions/common/run-autopkgtest@autopkgtests-source-name
      with:
        lxd-image: ubuntu:devel
        source-name: gnome-shell
        autopkgtest-args: |
          *.deb --setup-commands-boot='sed -i s,archive.ubuntu.com,azure.archive.ubuntu.com,g /etc/apt/sources.list.d/ubuntu.sources && apt update -y'
